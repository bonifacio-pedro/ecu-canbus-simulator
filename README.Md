# ğŸš— CAN Bus ECU Simulator

![CAN Bus](https://img.shields.io/badge/Protocol-CAN%20Bus-blue)
![Language](https://img.shields.io/badge/Language-C99-orange)
![Status](https://img.shields.io/badge/Status-Production%20Ready-success)

![TelemetrySim](ecu_telemetry_analysis.png)

> **Professional-grade automotive ECU simulator implementing ISO 11898 CAN protocol with multi-frame arbitration, realistic physics, and diagnostic system.**

## ğŸ¯ Features

- âœ… **Real CAN Bus Implementation**: Message arbitration, priority handling, broadcast
- âœ… **3 CAN Frames**: Powertrain (0x100), Dynamics (0x200), Sensors (0x300)
- âœ… **Realistic Physics**: Engine, throttle, brake, temperature simulation
- âœ… **Diagnostic System**: Error codes (DTC-like), multi-sensor monitoring
- âœ… **Telemetry Export**: CSV logging for post-analysis
- âœ… **Python Visualization**: Automated plotting and analysis
  
## ğŸ”’ Safety Features (NEW!)1. XOR Checksum Validation
1. XOR Checksum Validation
    Every CAN frame includes an XOR checksum to detect data corruption:
    ```c
    uint8_t can_checksum(const uint8_t *data, uint8_t len) {
        uint8_t cs = 0;
        for (uint8_t i = 0; i < len; i++) {
            cs ^= data[i];
        }
        return cs;
    }
    ``` 
    Protection against:
- âœ… Bit flips during transmission
- âœ… Electrical noise interference
- âœ… Hardware failures

2. Sequence Counter Validation
    Each frame type has an independent rolling counter (0-255):
    ```c
    static uint8_t seq_powertrain = 0;  // Increments with each transmission
    static uint8_t last_seq_powertrain = 0xFF;  // Tracks expected sequence
    ```
Detection of:
- âœ… Lost messages (gap in sequence)
- âœ… Duplicated messages (same sequence twice)
- âœ… Out-of-order messages (sequence jump)

3. Error Code System
When validation fails, specific error flags are set:
```c
typedef enum {
    ECU_ERR_NONE          = 0x00,
    ECU_ERR_CAN_CHECKSUM  = 0x01,
    ECU_ERR_CAN_SEQ       = 0x02,
    ECU_ERR_CAN_TIMEOUT   = 0x04,
    ECU_ERR_OVER_RPM      = 0x08,
    ECU_ERR_OVER_TEMP     = 0x10,
} ECUErrorCode;
```
## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CAN BUS SIMULATOR                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ECU_TX (Transmitter)
  â”‚
  â”œâ”€â†’ encode_powertrain_frame()  â†’ CAN ID 0x100
  â”‚    â”œâ”€ Data encoding
  â”‚    â”œâ”€ Sequence counter++
  â”‚    â””â”€ XOR checksum
  â”‚
  â”œâ”€â†’ encode_dynamics_frame()    â†’ CAN ID 0x200
  â”‚    â”œâ”€ Data encoding
  â”‚    â”œâ”€ Sequence counter++
  â”‚    â””â”€ XOR checksum
  â”‚
  â””â”€â†’ encode_sensors_frame()     â†’ CAN ID 0x300
       â”œâ”€ Data encoding
       â”œâ”€ Sequence counter++
       â””â”€ XOR checksum
                â”‚
                â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚          CAN BUS                   â”‚
   â”‚  â€¢ send()                          â”‚
   â”‚  â€¢ arbitrate() â† ğŸ”¥ (by priority)  â”‚
   â”‚  â€¢ deliver()                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“
ECU_RX (Receiver)
  â”‚
  â”œâ”€â†’ decode_powertrain_frame()
  â”‚    â”œâ”€ âœ“ Checksum validation
  â”‚    â”œâ”€ âœ“ Sequence validation
  â”‚    â””â”€ Data extraction
  â”‚
  â”œâ”€â†’ decode_dynamics_frame()
  â”‚    â”œâ”€ âœ“ Checksum validation
  â”‚    â”œâ”€ âœ“ Sequence validation
  â”‚    â””â”€ Data extraction
  â”‚
  â””â”€â†’ decode_sensors_frame()
       â”œâ”€ âœ“ Checksum validation
       â”œâ”€ âœ“ Sequence validation
       â””â”€ Data extraction
```

## ğŸš€ Quick Start
### Build
```bash
make
```
### Run
```bash
make run
```
### Analyze
```bash
jupyter notebook analyze_telemetry.ipynb
```

## ğŸ“Š CAN Frame Structure

### Frame 1: Powertrain (ID 0x100, DLC 4)
| Byte | Data | Format | Range |Notes
|------|------|--------|-------|----
| 0-1  | RPM  | uint16_t (Big-Endian) | 0-8000 |MSB first
| 2    | Gear | uint8_t | 0-6 |Automatic calculation
| 3    | Flags | Bit 1: Engine On<br>Bit 0: Brake | 0x00-0x03 |Bitwise packed
|4|Sequence|uint8_t|0-255|Rolling counter
|5|Checksum|uint8_t|0-255|XOR of bytes 0-4

### Frame 2: Dynamics (ID 0x200, DLC 4)
| Byte | Data | Format | Range |Notes
|------|------|--------|-------| ---
| 0 | Speed | uint8_t | 0-250 km/h |From RPM calculation
| 1 | Brake Pressure | uint8_t | 0-100% |Gradual increase
| 2 | Throttle | uint8_t | 0-100% |Input simulation
|3|Reserved|uint8_t| -|Future use
|4|Sequence|uint8_t|0-255|Rolling counter
|5|Checksum|uint8_t|0-255|XOR of bytes 0-4

### Frame 3: Sensors (ID 0x300, DLC 5)
| Byte | Data | Format | Range |Notes
|------|------|--------|-------|---
| 0 | Engine Temp | uint8_t | 0-255Â°C |Physics simulation
| 1 | Oil Pressure | uint8_t | 0-100 bar |RPM-based
| 2 | Battery Voltage | uint8_t | 0-255 (Ã—0.1V) |12.4V = 124
| 3 | Error Code | uint8_t | DTC codes |Multi-bit flags
| 3 | Error Code | uint8_t | DTC codes |Multi-bit flags
| 4 | Reserved |  | - |Future use
|5|Sequence|uint8_t|0-255|Rolling counter
|6|Checksum|uint8_t|0-255|XOR of bytes 0-4



## ğŸ“ˆ Sample Output
```
=== ACTUAL STATE ==
RPM: 4523
SPEED: 145
THROTTLE: 78
BRAKE: 0
GEAR: 4
ENGINE TEMP: 92
OIL PRESSURE: 65
BATTERY_VOLTAGE: 140
ERROR CODE: 0
===================
```

## ğŸ¯ Technical Highlights

**For Automotive Engineers:**
- ISO 11898 compliant message structure
- Multi-priority arbitration system
- Realistic sensor simulation with physics
- DTC-like error code system

**For Software Engineers:**
- Clean architecture (CAN protocol â†” ECU logic separation)
- Modular design (easy to add new frames)
- Production-quality code (error handling, documentation)
- Multi-language stack (C + Python)

## ğŸ“š Documentation

- [CAN.md](docs/CAN.md) - Complete CAN protocol explanation
- [analyze_telemetry.ipynb](analyze_telemetry.ipynb) - Data analysis notebook
## ğŸ› ï¸ Technologies

- **C99**: Core simulation
- **Python 3**: Data analysis
- **Jupyter**: Visualization
- **Make**: Build system

## ğŸ‘¤ Author

**Pedro Henrique BonifÃ¡cio da Rosa**  
Computer Engineering Student @ UNISINOS  
Focused on: Automotive Embedded Systems | CAN Protocol | ECU Development

ğŸ“§ pedrorosa.rb@gmail.com  
ğŸ’¼ [LinkedIn](https://www.linkedin.com/in/pedro-bonifÃ¡cio-9869a9263/)  

## ğŸ“„ License

MIT License - Feel free to use for learning and research!

---

â­ **If this project helped you understand CAN Bus, give it a star!**

*Built with precision for the automotive software community* ğŸš—ğŸ’¨